# Microsoft 365 Offboarding Script v2.1 Architecture

## Overview
Version 2.1 introduces a modular architecture that enhances maintainability, security, and functionality of the Microsoft 365 user offboarding process.

## Directory Structure

```
offboarding/
├── offboards.ps1                 # Main script (v2.1)
├── modules/                      # PowerShell modules
│   ├── AuthenticationModule.psm1 # M365 authentication handling
│   ├── UserOperationsModule.psm1 # User offboarding operations
│   └── LoggingModule.psm1        # Enhanced logging system
├── config/                       # Configuration files
│   └── sample_config.json        # Template configuration
├── templates/                    # Script templates
│   ├── PowerShellProfile.ps1     # PowerShell profile template
│   └── BulkUsers.csv             # CSV template for bulk operations
├── docs/                         # Documentation
│   └── v2.1-Architecture.md      # This file
└── logs/                         # Log files (created at runtime)
    ├── Errors_[timestamp].log
    ├── Passwords_[timestamp].log
    ├── InvalidUsers_[timestamp].log
    └── Audit_[timestamp].log
```

## Module Descriptions

### AuthenticationModule.psm1
- Handles Microsoft Graph and Exchange Online connections
- Supports both interactive and certificate-based authentication
- Validates required permissions and scopes
- Manages module installation and availability checks

### UserOperationsModule.psm1
- Contains all 14 offboarding operations as separate functions
- Improved error handling and parameter validation
- Modular design allows for easier testing and maintenance
- Consistent return values and status reporting

### LoggingModule.psm1
- Enhanced logging system with multiple log types
- Audit trail functionality for compliance
- Color-coded console output
- Log compression and export capabilities
- Centralized error handling

## Key Enhancements in v2.1

1. **Modular Architecture**: Separated concerns into dedicated modules
2. **Enhanced Logging**: Comprehensive audit trails and error tracking
3. **Better Error Handling**: Centralized error management with detailed logging
4. **Configuration Templates**: JSON-based configuration for easier setup
5. **PowerShell Profile**: Template for environment setup
6. **Documentation**: Improved documentation and code comments

## Usage Patterns

### Loading Modules
```powershell
Import-Module .\modules\AuthenticationModule.psm1
Import-Module .\modules\UserOperationsModule.psm1  
Import-Module .\modules\LoggingModule.psm1
```

### Authentication
```powershell
# Interactive authentication
Connect-M365Services -Interactive

# Certificate-based authentication
Connect-M365Services -TenantId "xxx" -ClientId "xxx" -CertificateThumbprint "xxx"
```

### Logging System
```powershell
# Initialize logging
Initialize-LoggingSystem -LogDirectory ".\logs"

# Write audit entries
Write-AuditLog -Message "Operation started" -Level "INFO" -UPN "user@domain.com"
```

## Migration from v2.0
The main script (`offboards.ps1`) maintains backward compatibility while leveraging the new modular architecture internally. Existing parameter structures and workflows remain unchanged for users.

## Future Enhancements
- Role-based access control
- Integration with Azure Key Vault for secrets management
- PowerShell DSC configurations
- REST API endpoints for remote execution
- Integration with ServiceNow or other ITSM platforms
